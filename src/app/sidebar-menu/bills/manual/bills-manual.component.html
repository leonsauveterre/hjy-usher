<div id="blog-bills-manual-container" class="blog-container mx-auto">
  <div class="blog-title">手动拉取任务</div>
  <div class="blog-sub-title">Leon Zhao | zhaoliang03&#64;huice.com, Nov 06, 2024</div>
  <div class="blog-part">
    <div class="blog-header-1">1 概述</div>
    <div class="blog-text-normal">手动拉取任务是为了弥补系统拉取任务没有拉取到的数据而诞生的，不适用于大量任务创建，也不能保证数据一定会补拉到，只是给用户提供手动拉取账单的入口，需要用户自行保证数据完整。</div>
    <div class="blog-text-normal">由于手动拉取任务可能随时出现，其调用次数比较频繁，因此有时会出现限流或平台内部错误等问题，属正常现象。对于未知错误，任务将给用户返回统一提示：<span class="blog-highlight-cyan">当前拉取任务异常</span>。其他信息详见下方。</div>
  </div>
  <div class="blog-part">
    <div class="blog-header-1">2 任务结构</div>
    <div class="blog-header-2">2.1 任务表</div>
    <div class="blog-text-normal">任务表1
      <span class="blog-highlight-compact">MySQL</span>
      <span class="blog-highlight-canary">manual_pull_task</span>（主表）
    </div>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>字段</th>
          <th>类型</th>
          <th>含义</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>pull_type</td>
          <td>INT</td>
          <td>拉取类型，详见下方枚举</td>
        </tr>
        <tr>
          <td>pull_start</td>
          <td>DATE</td>
          <td>要拉取账单的开始日期，格式：<span class="blog-highlight-cyan">yyyy-MM-dd</span></td>
        </tr>
        <tr>
          <td>pull_end</td>
          <td>DATE</td>
          <td>要拉取账单的结束日期，格式：<span class="blog-highlight-cyan">yyyy-MM-dd</span></td>
        </tr>
        <tr>
          <td>task_status</td>
          <td>TINYINT</td>
          <td>任务状态，详见下方枚举</td>
        </tr>
        <tr>
          <td>org_count</td>
          <td>INT</td>
          <td>拉取前原始单数量</td>
        </tr>
        <tr>
          <td>new_count</td>
          <td>INT</td>
          <td>拉取后原始单数量</td>
        </tr>
        <tr>
          <td>created_at</td>
          <td>DATETIME</td>
          <td>任务创建时间</td>
        </tr>
        <tr>
          <td>started_at</td>
          <td>DATETIME</td>
          <td>任务开始时间</td>
        </tr>
        <tr>
          <td>completed_at</td>
          <td>DATETIME</td>
          <td>任务完成时间</td>
        </tr>
        <tr>
          <td>registrar</td>
          <td>VARCHAR(128)</td>
          <td>任务发起人</td>
        </tr>
        <tr>
          <td>failure_reason</td>
          <td>VARCHAR(128)</td>
          <td>失败原因</td>
        </tr>
        <tr>
          <td>其他字段</td>
          <td>--</td>
          <td>其他字段为通用或 ERP 约定字段，意义与其他表一致</td>
        </tr>
      </tbody>
    </table>
    <div class="blog-paragraph-break"></div>
    <div class="blog-text-normal">任务表2
      <span class="blog-highlight-compact">MySQL</span>
      <span class="blog-highlight-canary">manual_pull_task_divided</span>（子表）
    </div>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>字段</th>
          <th>类型</th>
          <th>含义</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>main_id</td>
          <td>BIGINT</td>
          <td>来自主表的<span class="blog-highlight-cyan">id</span>字段</td>
        </tr>
        <tr>
          <td>verified_at</td>
          <td>DATETIME</td>
          <td>任务校验时间</td>
        </tr>
        <tr>
          <td>proof</td>
          <td>VARCHAR(1024)</td>
          <td>校验结果</td>
        </tr>
        <tr>
          <td>其他字段</td>
          <td>--</td>
          <td>其他字段与主表完全相同，但主表项一旦落库永不改变，只有子表会显示实际任务状态</td>
        </tr>
      </tbody>
    </table>
    <div class="blog-paragraph-break"></div>
    <div class="blog-question-title">为什么会有两张表？</div>
    <div class="alert alert-success">历史遗留问题。初版需求中，只需要主表记录任务信息，但由于拉取任务只能按天拉取，因此极有可能拉取时间很长，且只能记录任务总状态，无法准确记录每个日期拉取情况，且研发无法取消其中某几条任务。后来，主表只记录用户在页面上创建的任务，子表会记录具体每个子任务的状态。例如，主表中用户发起快手账单补拉任务，日期范围为 10 月 1 日到 10 月 15 日，假设此任务 id 为 606，那么子表中会入库 15 条数据，每项的 <span class="blog-highlight-cyan">pull_start</span> 和 <span class="blog-highlight-cyan">pull_end</span> 为同一日期，即将 15 天的任务拆成 15 个子任务，这些任务的 <span class="blog-highlight-cyan">main_id</span> 均为 606。待任务完成后，子表中的 <span class="blog-highlight-cyan">new_count</span> 和 <span class="blog-highlight-cyan">org_count</span> 相减即为新补拉来的账单数，而主表任何字段的值都永远不变。</div>
    <div class="blog-header-2">2.2 字段枚举</div>
    <div class="blog-text-normal"><span class="blog-highlight-canary">pull_type</span></div>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>枚举</th>
          <th>说明</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>10</td>
          <td>支付宝</td>
        </tr>
        <tr>
          <td>20</td>
          <td>京东（无优惠券）</td>
        </tr>
        <tr>
          <td>21</td>
          <td>京东（有优惠券）</td>
        </tr>
        <tr>
          <td>22</td>
          <td>京东优惠券（此时该任务一定配有 <span class="blog-highlight-cyan">pull_type</span> 为 21 的任务，配比 1:1）</td>
        </tr>
        <tr>
          <td>30</td>
          <td>京东钱包</td>
        </tr>
        <tr>
          <td>40</td>
          <td>抖店</td>
        </tr>
        <tr>
          <td>50</td>
          <td>快手</td>
        </tr>
        <tr>
          <td>60</td>
          <td>京准通</td>
        </tr>
        <tr>
          <td>110</td>
          <td>京东快车-到链接（暂未开发，待定中）</td>
        </tr>
        <tr>
          <td>120</td>
          <td>快手超售后期账单</td>
        </tr>
        <tr>
          <td>130</td>
          <td>快手安心钱包</td>
        </tr>
        <tr>
          <td>140</td>
          <td>视频号资金流水</td>
        </tr>
        <tr>
          <td class="blog-deprecation">150</td>
          <td>快手新接口（过度时期专用，当前已弃用）</td>
        </tr>
        <tr>
          <td>160</td>
          <td>小红书订单货款</td>
        </tr>
        <tr>
          <td>170</td>
          <td>小红书其他服务款</td>
        </tr>
        <tr>
          <td>180</td>
          <td>小红书人工调账</td>
        </tr>
      </tbody>
    </table>
    <div class="blog-paragraph-break"></div>
    <div class="blog-text-normal"><span class="blog-highlight-canary">task_status</span></div>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>枚举</th>
          <th>说明</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>0</td>
          <td>已取消（仅能通过研发后台操作）</td>
        </tr>
        <tr>
          <td>10</td>
          <td>待拉取</td>
        </tr>
        <tr>
          <td>20</td>
          <td>任务准备开始执行</td>
        </tr>
        <tr>
          <td>21</td>
          <td>开始补拉原始单</td>
        </tr>
        <tr>
          <td>22</td>
          <td>原始单补拉完成</td>
        </tr>
        <tr>
          <td>23</td>
          <td>正在转标准单（京东优惠券和京准通无需此步骤，补拉完原始单后状态直接变为 24）</td>
        </tr>
        <tr>
          <td>24</td>
          <td>标准单转换完成</td>
        </tr>
        <tr>
          <td>25</td>
          <td>正在分摊中</td>
        </tr>
        <tr>
          <td>26</td>
          <td>等待回调经分（仅京东优惠券和京准通有此步骤，其他任务的状态会从 25 变为 30 或 80）</td>
        </tr>
        <tr>
          <td>30</td>
          <td>任务完成</td>
        </tr>
        <tr>
          <td>80</td>
          <td>拉取异常</td>
        </tr>
      </tbody>
    </table>
    <div class="blog-paragraph-break"></div>
    <div class="blog-text-normal"><span class="blog-highlight-canary">failure_reason</span></div>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>枚举</th>
          <th>说明</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>账单不存在</td>
          <td>仅供支付宝账单用</td>
        </tr>
        <tr>
          <td>应用未绑定商户账号，参见：https://opendocs.alipay.com/open/00r5uy</td>
          <td>仅供支付宝账单用</td>
        </tr>
        <tr>
          <td>请先在支付宝后台配置【发生时间】字段并回刷对应时间段的历史账单后重试</td>
          <td>仅供支付宝账单用</td>
        </tr>
        <tr>
          <td>没有生效的安心钱包</td>
          <td>仅供快手安心钱包账单用，一般是因为用户可用的安心钱包数不是 1（可能是 0，也可能大于 1）</td>
        </tr>
        <tr>
          <td>拉取权限被平台撤回</td>
          <td>仅供快手安心钱包账单用，错误由平台返回</td>
        </tr>
        <tr>
          <td>拉取到的文件内容缺失结算时间</td>
          <td>仅供京东货款流水账单用</td>
        </tr>
        <tr>
          <td>未找到当前账号下已授权店铺</td>
          <td>通用异常信息</td>
        </tr>
        <tr>
          <td>店铺授权失效，请重新授权</td>
          <td>通用异常信息</td>
        </tr>
        <tr>
          <td>ERP授权过期，需ERP重新授权后，再于慧经营重新授权</td>
          <td>通用异常信息</td>
        </tr>
        <tr>
          <td>Token 非法，请重新授权ERP</td>
          <td>通用异常信息</td>
        </tr>
        <tr>
          <td>当前拉取任务异常</td>
          <td>通用异常信息，说明程序遇到了未知问题，需要通过日志和子表的 <span class="blog-highlight-cyan">reserved_field4</span> 排查</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="blog-part">
    <div class="blog-header-1">3 常见问题排查</div>
    <div class="blog-header-2">3.1 查看任务信息</div>
    <div class="blog-text-normal"><span class="blog-highlight-canary">按条件查询任务</span></div>
    <div class="input-group mb-3" id="bills-manual-input-3-1-cond1">
      <div class="input-group-prepend">
        <span class="input-group-text" id="bills-manual-input-3-1-tenant-id">Tenant ID</span>
      </div>
      <input type="text" class="form-control" placeholder="tenant_id，可用英文逗号拼接" aria-describedby="bills-manual-input-3-1-tenant-id">
    </div>
    <div class="mt-3" id="bills-manual-input-3-1-cond2">
      <div class="d-flex align-items-center input-group-prepend">
        <span class="input-group-text" id="bills-manual-input-3-1-task-types">Task Types</span>
        <button type="button" class="btn btn-outline-primary btn-sm ms-1" (click)="selectAllCheckboxesForCond2()">Select All</button>
        <button type="button" class="btn btn-outline-secondary btn-sm ms-1" (click)="invertCheckboxSelectionForCond2()">Invert Selection</button>
      </div>
      <div class="blog-cond-container">
        <table class="blog-cond-border">
          <tbody>
            <tr>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb1" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb1">支付宝</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb2" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb2">京东货款流水</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb3" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb3">京东货款流水（包括优惠券）</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb4" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb4">京东钱包</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb5" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb5">抖店货款</label>
              </td>
            </tr>
            <tr>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb6" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb6">快手小店货款</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb7" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb7">京准通</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb8" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb8">快手超售后期</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb9" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb9">快手安心钱包</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb10" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb10">视频号资金流水</label>
              </td>
            </tr>
            <tr>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb11" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb11">小红书订单货款</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb12" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb12">小红书其他服务款</label>
              </td>
              <td>
                <input class="form-check-input" type="checkbox" id="manual-bills-cond-2-cb13" />
                <label class="form-check-label ms-1" for="manual-bills-cond-2-cb13">小红书人工调账</label>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="mt-3" id="bills-manual-input-3-1-cond3">
      <div class="d-flex align-items-center input-group-prepend">
        <span class="input-group-text" id="bills-manual-input-3-1-task-statuses">Task Statuses</span>
      </div>
      <div class="blog-cond-container">
        <table class="blog-cond-border">
          <tbody>
            <tr>
              <td>
                <input class="form-check-input" type="radio" id="manual-bills-cond-3-rd1" name="manual-bills-cond-3" checked="checked" />
                <label class="form-check-label ms-1" for="manual-bills-cond-3-rd1">所有状态</label>
              </td>
              <td>
                <input class="form-check-input" type="radio" id="manual-bills-cond-3-rd2" name="manual-bills-cond-3" />
                <label class="form-check-label ms-1" for="manual-bills-cond-3-rd2">待执行</label>
              </td>
              <td>
                <input class="form-check-input" type="radio" id="manual-bills-cond-3-rd3" name="manual-bills-cond-3" />
                <label class="form-check-label ms-1" for="manual-bills-cond-3-rd3">分摊中</label>
              </td>
              <td>
                <input class="form-check-input" type="radio" id="manual-bills-cond-3-rd4" name="manual-bills-cond-3" />
                <label class="form-check-label ms-1" for="manual-bills-cond-3-rd4">已完成</label>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="mt-3" id="bills-manual-input-3-1-cond4">
      <div class="d-flex align-items-center input-group-prepend">
        <span class="input-group-text" id="bills-manual-input-3-1-created-at">Time of Creation</span>
        <button type="button" class="btn btn-outline-primary btn-sm ms-1" (click)="selectTodayForCond4()">Today</button>
        <button type="button" class="btn btn-outline-primary btn-sm ms-1" (click)="selectYesterdayForCond4()">Yesterday</button>
        <button type="button" class="btn btn-outline-primary btn-sm ms-1" (click)="selectLast35HoursForCond4()">Within 35 Hours</button>
        <button type="button" class="btn btn-outline-primary btn-sm ms-1" (click)="selectLast3DaysForCond4()">Within Last 3 Days</button>
      </div>
      <div class="blog-cond-container">
        <table class="blog-cond-border">
          <tbody>
            <tr style="height: 45px">
              <td class="blog-right-align"><label for="bills-manual-input-3-1-cond4-start-dt" class="form-label me-2">From</label></td>
              <td class="d-flex">
                <input id="bills-manual-input-3-1-cond4-start-dt" type="datetime-local" [(ngModel)]="startDateTime" (change)="validateDateTime('start')" [max]="maxDateTime" class="form-control" />
              </td>
              <td class="blog-right-align"><label for="bills-manual-input-3-1-cond4-end-dt" class="form-label ms-3 me-2">through</label></td>
              <td class="d-flex">
                <input id="bills-manual-input-3-1-cond4-end-dt" type="datetime-local" [(ngModel)]="endDateTime" (change)="validateDateTime('end')" [max]="maxDateTime" class="form-control" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="mt-3 ground-control">
      <button id="bills-manual-input-3-1-query" type="button" class="btn btn-success" (click)="genSQLS03E01()">🤹 Generate SQL</button>
    </div>
    <app-code-display [code]="generatedSQLS03E01" language="sql"></app-code-display>
  </div>
</div>
